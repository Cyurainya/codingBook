### 概念

位址解析協定 (Address Resolution Protocol)

通过解析**网络层**地址来寻找**数据链路层地址**（例如 MAC 地址）的网络传输协议

### 用途

从网络层使用的**IP 地址**中解析出的**数据链路层**使用的硬件地。所以其消息是由**数据链路层**的协议封装的

**ARP 是局域网内部的协议，他解决的是同一个局域网内部的主机或路由器的 IP 地址和其对应的硬件地址的映射问题**

### MAC 和 IP 的区别

##### MAC:

用来识别同一链路中不同的计算机，每个网卡出厂时的 MAC 地址都是唯一且固定的

##### IP：

用来识别 TCP/IP 网络中互连的主机和路由器

### 那为什么有了 IP 还需要 MAC 呢

因为光靠 ip 地址是无法通信的，ip 地址并不和某台设备绑定。比如你的笔记本的 ip 在家跟在公司肯定是不一样的

#### ARP 的主要内容：

- 主机**A**要向某网络**X**发送数据的时候，需要先在其**ARP 高速缓存**中查看有无网络**X**的 IP 地址。如果有，则直接在**ARP 高速缓存**查出其对应的**物理地址**

- 如果没有，则主机**A**的**ARP 进程**在**本地局域网**发送**ARP 请求广播**

![广播图](./ARP-broadcast.png)

- 在本地**局域网**中的所有主机上运行的 ARP 进程都会收到这个 ARP 请求

- 主机**D**的**IP 地址**和要查询的网络设备**X**一样，它在收到该**ARP 请求**后像主机
  A 发送**ARP 响应**

- 主机 A 收到主机 B 的 ARP 响应后，会在其**ARP 高速缓存**中记录主机 B 的**IP 地址**到其**硬件地址**的映射

### ARP 过程

**所需要的东西**：

1. 一个目标 IP 地址

2. 用于发送 ARP 广播的接口的 MAC 地址

- 先查询 ARP 缓存，中了就直接返回：`ip = MAC`

如果缓存没有命中：

- 查看路由表，看看目标 ip 地址是不是在本地路由表中的某个子网内 ？ 使用跟那个子网相连的接口 ：使用默认网关相连的接口

- 查询选择的网络接口的 MAC 地址

- 向数据链路层发送一个 ARP 请求

但是，根据连接主机和路由器的硬件类型不同，我们可以分为以下几种情况：

直连：

- 如果我们和路由器是直连的，路由器会返回一个`ARP Reply`

集线器：

- 如果我们连接到一个集线器，集线器会把 ARP 请求向其他端口广播，那这里如果路由器也“连接”在其中，也会返回一个`ARP Reply`

交换机：

- 如果我们连接到了一个交换机，交换机会检查**本地 CAM/MAC 表**，看看哪个端口有我们要找的那个 MAC 地址。如果没有找到，交换机会向所有其他端口广播这个 ARP 请求

- 如果交换机的 MAC/CAM 表中有对应的条目，交换机会向我们想要的查询的 MAC 地址的那个关口发送 ARP 请求

- 如果路由器也“连接”在其中，它会返回一个` ARP Reply`

然后就可以继续 DNS 请求了
