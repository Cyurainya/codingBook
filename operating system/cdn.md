## 概念

CDN（Content Delivery Network，内容分发网络）是构建在现有互联网基础之上的一层智能虚拟网络，通过在网络各处部署节点服务器，实现将源站内容分发至所有 CDN 节点，使用户可以就近获得所需的内容。

简单的说，CDN 的工作原理就是将您源站的资源缓存到位于全球各地的 CDN 节点上，用户请求资源时，就近返回节点上缓存的资源，而不需要每个用户的请求都回您的源站获取，避免网络拥塞、缓解源站压力，保证用户访问资源的速度和体验。

## 优点

- CDN 服务缩短了用户查看内容的访问延迟，提高了用户访问网站的响应速度；(终端用户内容获取延时高，比如服务器在北京，而用户在广州)

- 解决了源站网络带宽小、用户访问量大、网点分布不均等问题，缓解了源站的压力；(中心服务器负载过高，因为所有客户端发起的请求都会打到服务器上)

- 缓解甚至消除了不同运营商之间互联的瓶颈造成的影响；

- 减轻了各省的出口带宽压力；

- 缓解了骨干网的压力；

- 优化了网上热点内容的分布；

## 过程

1. 首先访问`本地的 DNS` ，如果没有命中，继续递归或者迭代查找，直到命中拿到对应的 IP 地址。
2. 拿到对应的 IP 地址之后`服务器端发送请求到目的地址`。注意这里返回的不直接是 cdn 服务器的 IP 地址，而是全局负载均衡系统的 IP 地址
3. 全局负载均衡系统会根据客户端的 IP 地址和请求的 url 和相应的区域负载均衡系统通信
4. 区域负载均衡系统拿着这两个东西获取距离客户端最近且有相应资源的 cdn 缓存服务器的地址，返回给全局负载均衡系统
5. 全局负载均衡系统返回确定的 cdn 缓存服务器的地址给客户端。
6. 客户端请求缓存服务器上的文件

## 回源

当 cdn 缓存服务器中没有符合客户端要求的资源的时候，缓存服务器会请求上一级缓存服务器，以此类推，直到获取到。最后如果还是没有，就会回到我们自己的服务器去获取资源

回源的时机：

- 没有资源；

- 资源过期；

- 访问的资源是不可缓存的；

## 回源 host

回源 host：回源 host 决定回源请求访问到源站上的具体某个站点。

例子 1：源站是域名源站为www.a.com, 回源 host 为www.b.com, 那么实际回源是请求到 www.a.com 解析到的 IP, 对应的主机上的站点www.b.com

例子 2：源站是 IP 源站为 1.1.1.1, 回源 host 为www.b.com,那么实际回源的是1.1.1.1对应的主机上的站点 www.b.com

## 参考文献

1. [cdn 一网打尽](https://juejin.cn/post/6844903604596244493)
2. [CDN 的基本工作过程](https://book.51cto.com/art/201205/338756.htm)
3. [CDN 原理](https://mp.weixin.qq.com/s/8IzDE4blQ_yC6z90q55UhA)
